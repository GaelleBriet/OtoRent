# API O'To Rent

## Introduction

Cette API a √©t√© d√©velopp√©e dans le contexte de l'√©volution d'O'To Rent afin de r√©pondre √† des exigences applicatives multiples.

## Installation et lancement (classique)

> ‚õî Si vous souhaitez utiliser Docker, et installer et lancer l'API en une seule commande, passez √† la section suivante.

### Installation des d√©pendances n√©cessaires au projet

```
npm install
```

### Mise en place de la base de donn√©es

- Se connecter √† PostgreSQL

  ```bash
  sudo -i -u postgres psql
  ```
  > üîì `par dessus les nuages`

- D√©finir un nouvel utilisateur PostgreSQL qui sera le propri√©taire de la base de donn√©es que nous cr√©erons juste apr√®s (e.g. `otorent` peut √™tre un bon nom d'utilisateur) 

  ```postgres
  CREATE ROLE oto-rent WITH LOGIN PASSWORD 'oto-rent-pw';
  ```

- Cr√©er une base de donn√©es PostgreSQL (e.g. `oto-rent` peut √™tre un bon nom de base de donn√©es)

  ```postgres
  CREATE DATABASE oto-rent OWNER oto-rent;
  ```

- Se placer dans le r√©pertoire `data` de ce d√©p√¥t puis ajouter les droits en ex√©cution pour le script de construction de la BDD

  ```bash
  sudo chmod +x construct_db.sh
  ```

- Adapter le script `construct_db.sh` si le nom d'utilisateur et/ou le nom de la base de donn√©es ne sont pas `oto-rent`

- Lancer le script

  ```bash
  bash ./construct_db.sh
  ```

  La base de donn√©es doit √™tre pr√™te, et des donn√©es fake y ont √©t√© ajout√©es. 

  üëÄ Aucune r√©servation ou utilisateur ne sont fournis.

### Compl√©ter le fichier d'environnement

  - SERVER_PORT : le port sur lequel le server se mettra en √©coute
  - JWT_SECRET : une cl√© servant √† g√©n√©rer les tokens JWT
    - Il est conseill√© de g√©n√©rer une cl√© en MD5 pour complexifier la g√©n√©ration des tokens JWT
    - Prendre un mot usuel et le [hasher en MD5](https://md5decrypt.net/)
    - Une fois le md5 r√©cup√©r√©, l'utiliser en valeur pour le JWT_SECRET
  - Les param√®tres de connexion √† la base de donn√©es

### Lancer l'application

Plusieurs choix possibles :

- Pour un d√©marrage standard

  ```bash
  npm run start
  ```

- Pour un lancement en d√©veloppement (avec le watcher nodemon)

  ```bash
  sudo npm install -g nodemon

  npm run dev
  ```

## Installation et lancement avec Docker

```bash
npm run docker:start
```

## Utilisation

### Documentation

Une documentation globale de l'API est disponible sur l'url `/api-docs` renseignant les fonctionnalit√©s disponibles et les param√®tres n√©cessaires.

### Droits & privil√®ges

Attention, si certaines URL ne n√©cessitent pas de droit sp√©cifique (e.g. la liste des agences), d'autres auront besoin que l'utilisateur soit connect√© pour pouvoir les utiliser (e.g. l'acc√®s √† une r√©servation) voire m√™me qu'il ait le r√¥le `fleetManager` (e.g. la mise √† jour d'un v√©hicule).

M√™me s'il existe une URL permettant de cr√©er un nouveau compte `/auth/register`, le compte cr√©√© poss√©dera par d√©faut le r√¥le `user`. Pour des raisons de s√©curit√©, aucun passage de `user` √† `fleetManager` n'est possible pour l'instant. Il faudra donc directement se connecter √† la base de donn√©es et faire la mise √† jour √† la main le temps que le client envisage comment faire la mont√©e de privil√®ges.

```sql
UPDATE account SET role = 'fleetManager' WHERE id = <id_de_lutilisateur>;
```

#### Mots de passe

‚ö†Ô∏è Il n'est pas garantie que cela fonctionne mais les mots de passe pour Bruce Wayne et Tony Stark devraient respectivement √™tre `batman` et `ironman`.

### Logs du server

Les logs du server API sont sauvegard√©s dans le r√©pertoire `logs` pr√©sent √† la racine. Ils sont journalis√©s, ce qui permet de supprimer les logs les plus anciens quand on estime qu'ils ne sont plus utiles.
